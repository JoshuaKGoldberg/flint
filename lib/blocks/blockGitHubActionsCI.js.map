{"version":3,"file":"blockGitHubActionsCI.js","names":[],"sources":["../../src/blocks/blockGitHubActionsCI.ts"],"sourcesContent":["import { z } from \"zod\";\n\nimport { base } from \"../base.js\";\nimport { resolveUses } from \"./actions/resolveUses.js\";\nimport { intakeFileYamlSteps, zActionStep } from \"./actions/steps.js\";\nimport { blockRemoveFiles } from \"./blockRemoveFiles.js\";\nimport { blockRepositoryBranchRuleset } from \"./blockRepositoryBranchRuleset.js\";\nimport { createMultiWorkflowFile } from \"./files/createMultiWorkflowFile.js\";\nimport { createSoloWorkflowFile } from \"./files/createSoloWorkflowFile.js\";\nimport { formatYaml } from \"./files/formatYaml.js\";\n\nexport const blockGitHubActionsCI = base.createBlock({\n\tabout: {\n\t\tname: \"GitHub Actions CI\",\n\t},\n\taddons: {\n\t\tjobs: z\n\t\t\t.array(\n\t\t\t\tz.object({\n\t\t\t\t\tcheckoutWith: z.record(z.string(), z.string()).optional(),\n\t\t\t\t\tif: z.string().optional(),\n\t\t\t\t\tname: z.string(),\n\t\t\t\t\tsteps: z.array(zActionStep),\n\t\t\t\t}),\n\t\t\t)\n\t\t\t.optional(),\n\t\tnodeVersion: z.union([z.number(), z.string()]).optional(),\n\t},\n\tintake({ files }) {\n\t\tconst steps = intakeFileYamlSteps(\n\t\t\tfiles,\n\t\t\t[\".github\", \"actions\", \"prepare\", \"action.yaml\"],\n\t\t\t[\"runs\", \"steps\"],\n\t\t);\n\t\tif (!steps) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst setupNodeStep = steps.find(\n\t\t\t(step) =>\n\t\t\t\ttypeof step.uses === \"string\" &&\n\t\t\t\tstep.uses.startsWith(\"actions/setup-node\"),\n\t\t);\n\t\tif (!setupNodeStep) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\tconst nodeVersion = setupNodeStep.with?.[\"node-version\"];\n\t\tif (!nodeVersion) {\n\t\t\treturn undefined;\n\t\t}\n\n\t\treturn { nodeVersion };\n\t},\n\tproduce({ addons, options }) {\n\t\tconst { jobs, nodeVersion = options.node.pinned ?? options.node.minimum } =\n\t\t\taddons;\n\n\t\treturn {\n\t\t\taddons: [\n\t\t\t\tblockRepositoryBranchRuleset({\n\t\t\t\t\trequiredStatusChecks: jobs?.map((job) => job.name),\n\t\t\t\t}),\n\t\t\t],\n\t\t\tfiles: {\n\t\t\t\t\".github\": {\n\t\t\t\t\tactions: {\n\t\t\t\t\t\tprepare: {\n\t\t\t\t\t\t\t\"action.yaml\": formatYaml({\n\t\t\t\t\t\t\t\tdescription: \"Prepares the repo for a typical CI job\",\n\t\t\t\t\t\t\t\tname: \"Prepare\",\n\t\t\t\t\t\t\t\truns: {\n\t\t\t\t\t\t\t\t\tsteps: [\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tuses: resolveUses(\n\t\t\t\t\t\t\t\t\t\t\t\t\"pnpm/action-setup\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"v4\",\n\t\t\t\t\t\t\t\t\t\t\t\toptions.workflowsVersions,\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tuses: resolveUses(\n\t\t\t\t\t\t\t\t\t\t\t\t\"actions/setup-node\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"v4\",\n\t\t\t\t\t\t\t\t\t\t\t\toptions.workflowsVersions,\n\t\t\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\t\t\twith: {\n\t\t\t\t\t\t\t\t\t\t\t\tcache: \"pnpm\",\n\t\t\t\t\t\t\t\t\t\t\t\t\"node-version\": nodeVersion,\n\t\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\trun: \"pnpm install --frozen-lockfile\",\n\t\t\t\t\t\t\t\t\t\t\tshell: \"bash\",\n\t\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\t\t\tusing: \"composite\",\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t\tworkflows: {\n\t\t\t\t\t\t\"ci.yaml\":\n\t\t\t\t\t\t\tjobs &&\n\t\t\t\t\t\t\tcreateMultiWorkflowFile({\n\t\t\t\t\t\t\t\tjobs: jobs.sort((a, b) => a.name.localeCompare(b.name)),\n\t\t\t\t\t\t\t\tname: \"CI\",\n\t\t\t\t\t\t\t\tworkflowsVersions: options.workflowsVersions,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\"pr-review-requested.yaml\": createSoloWorkflowFile({\n\t\t\t\t\t\t\tname: \"PR Review Requested\",\n\t\t\t\t\t\t\ton: {\n\t\t\t\t\t\t\t\tpull_request_target: {\n\t\t\t\t\t\t\t\t\ttypes: [\"review_requested\"],\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tpermissions: {\n\t\t\t\t\t\t\t\t\"pull-requests\": \"write\",\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tsteps: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tuses: resolveUses(\n\t\t\t\t\t\t\t\t\t\t\"actions-ecosystem/action-remove-labels\",\n\t\t\t\t\t\t\t\t\t\t\"v1\",\n\t\t\t\t\t\t\t\t\t\toptions.workflowsVersions,\n\t\t\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\t\t\twith: {\n\t\t\t\t\t\t\t\t\t\tlabels: \"status: waiting for author\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif: \"failure()\",\n\t\t\t\t\t\t\t\t\trun: 'echo \"Don\\'t worry if the previous step failed.\"\\necho \"See https://github.com/actions-ecosystem/action-remove-labels/issues/221.\"\\n',\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t}),\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t},\n\ttransition() {\n\t\treturn {\n\t\t\taddons: [\n\t\t\t\tblockRemoveFiles({\n\t\t\t\t\tfiles: [\".circleci\", \"travis.yaml\"],\n\t\t\t\t}),\n\t\t\t],\n\t\t};\n\t},\n});\n"],"mappings":";;;;;;;;;;;AAWA,MAAa,uBAAuB,KAAK,YAAY;CACpD,OAAO,EACN,MAAM,qBACN;CACD,QAAQ;EACP,MAAM,EACJ,MACA,EAAE,OAAO;GACR,cAAc,EAAE,OAAO,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,CAAC,UAAU;GACzD,IAAI,EAAE,QAAQ,CAAC,UAAU;GACzB,MAAM,EAAE,QAAQ;GAChB,OAAO,EAAE,MAAM,YAAY;GAC3B,CAAC,CACF,CACA,UAAU;EACZ,aAAa,EAAE,MAAM,CAAC,EAAE,QAAQ,EAAE,EAAE,QAAQ,CAAC,CAAC,CAAC,UAAU;EACzD;CACD,OAAO,EAAE,SAAS;EACjB,MAAM,QAAQ,oBACb,OACA;GAAC;GAAW;GAAW;GAAW;GAAc,EAChD,CAAC,QAAQ,QAAQ,CACjB;AACD,MAAI,CAAC,MACJ;EAGD,MAAM,gBAAgB,MAAM,MAC1B,SACA,OAAO,KAAK,SAAS,YACrB,KAAK,KAAK,WAAW,qBAAqB,CAC3C;AACD,MAAI,CAAC,cACJ;EAGD,MAAM,cAAc,cAAc,OAAO;AACzC,MAAI,CAAC,YACJ;AAGD,SAAO,EAAE,aAAa;;CAEvB,QAAQ,EAAE,QAAQ,WAAW;EAC5B,MAAM,EAAE,MAAM,cAAc,QAAQ,KAAK,UAAU,QAAQ,KAAK,YAC/D;AAED,SAAO;GACN,QAAQ,CACP,6BAA6B,EAC5B,sBAAsB,MAAM,KAAK,QAAQ,IAAI,KAAK,EAClD,CAAC,CACF;GACD,OAAO,EACN,WAAW;IACV,SAAS,EACR,SAAS,EACR,eAAe,WAAW;KACzB,aAAa;KACb,MAAM;KACN,MAAM;MACL,OAAO;OACN,EACC,MAAM,YACL,qBACA,MACA,QAAQ,kBACR,EACD;OACD;QACC,MAAM,YACL,sBACA,MACA,QAAQ,kBACR;QACD,MAAM;SACL,OAAO;SACP,gBAAgB;SAChB;QACD;OACD;QACC,KAAK;QACL,OAAO;QACP;OACD;MACD,OAAO;MACP;KACD,CAAC,EACF,EACD;IACD,WAAW;KACV,WACC,QACA,wBAAwB;MACvB,MAAM,KAAK,MAAM,GAAG,MAAM,EAAE,KAAK,cAAc,EAAE,KAAK,CAAC;MACvD,MAAM;MACN,mBAAmB,QAAQ;MAC3B,CAAC;KACH,4BAA4B,uBAAuB;MAClD,MAAM;MACN,IAAI,EACH,qBAAqB,EACpB,OAAO,CAAC,mBAAmB,EAC3B,EACD;MACD,aAAa,EACZ,iBAAiB,SACjB;MACD,OAAO,CACN;OACC,MAAM,YACL,0CACA,MACA,QAAQ,kBACR;OACD,MAAM,EACL,QAAQ,8BACR;OACD,EACD;OACC,IAAI;OACJ,KAAK;OACL,CACD;MACD,CAAC;KACF;IACD,EACD;GACD;;CAEF,aAAa;AACZ,SAAO,EACN,QAAQ,CACP,iBAAiB,EAChB,OAAO,CAAC,aAAa,cAAc,EACnC,CAAC,CACF,EACD;;CAEF,CAAC"}