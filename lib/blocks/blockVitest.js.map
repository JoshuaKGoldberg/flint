{"version":3,"file":"blockVitest.js","names":[],"sources":["../../src/blocks/blockVitest.ts"],"sourcesContent":["import { IntakeDirectory } from \"bingo-fs\";\nimport { z } from \"zod\";\n\nimport { base } from \"../base.js\";\nimport { getPackageDependencies } from \"../data/packageData.js\";\nimport { zActionStep } from \"./actions/steps.js\";\nimport { blockCSpell } from \"./blockCSpell.js\";\nimport { blockDevelopmentDocs } from \"./blockDevelopmentDocs.js\";\nimport { blockESLint } from \"./blockESLint.js\";\nimport { blockExampleFiles } from \"./blockExampleFiles.js\";\nimport { blockGitHubActionsCI } from \"./blockGitHubActionsCI.js\";\nimport { blockGitignore } from \"./blockGitignore.js\";\nimport { blockKnip } from \"./blockKnip.js\";\nimport { blockPackageJson } from \"./blockPackageJson.js\";\nimport { blockPrettier } from \"./blockPrettier.js\";\nimport { blockRemoveDependencies } from \"./blockRemoveDependencies.js\";\nimport { blockRemoveFiles } from \"./blockRemoveFiles.js\";\nimport { blockRemoveWorkflows } from \"./blockRemoveWorkflows.js\";\nimport { blockTSDown } from \"./blockTSDown.js\";\nimport { blockVSCode } from \"./blockVSCode.js\";\nimport { intakeFileDefineConfig } from \"./intake/intakeFileDefineConfig.js\";\n\nconst zCoverage = z.object({\n\texclude: z.array(z.string()).optional(),\n\tinclude: z.array(z.string()).optional(),\n});\n\nconst zEnvironment = z.string();\n\nconst zExclude = z.array(z.string());\n\nconst zTest = z\n\t.object({\n\t\tcoverage: zCoverage,\n\t\tenvironment: zEnvironment,\n\t\texclude: zExclude,\n\t})\n\t.partial();\n\nfunction intakeFromConfig(files: IntakeDirectory) {\n\tconst rawData = intakeFileDefineConfig(files, [\"vitest.config.ts\"]);\n\tif (typeof rawData?.test !== \"object\") {\n\t\treturn undefined;\n\t}\n\n\tconst parsedData = zTest.safeParse(rawData.test).data;\n\tif (!parsedData) {\n\t\treturn undefined;\n\t}\n\n\treturn {\n\t\tcoverage: parsedData.coverage,\n\t\tenvironment: parsedData.environment,\n\t\texclude: parsedData.exclude,\n\t};\n}\n\nexport const blockVitest = base.createBlock({\n\tabout: {\n\t\tname: \"Vitest\",\n\t},\n\taddons: {\n\t\tactionSteps: z.array(zActionStep).default([]),\n\t\tcoverage: zCoverage.default({}),\n\t\tenvironment: zEnvironment.optional(),\n\t\texclude: zExclude.default([]),\n\t\tflags: z.array(z.string()).default([]),\n\t},\n\tintake({ files, options }) {\n\t\treturn {\n\t\t\t...intakeFromConfig(files),\n\t\t\tflags: options.packageData?.scripts?.test\n\t\t\t\t?.match(/^vitest (.+)/)?.[1]\n\t\t\t\t.split(\" \"),\n\t\t};\n\t},\n\tproduce({ addons }) {\n\t\tconst { actionSteps, coverage, environment, exclude = [] } = addons;\n\t\tconst excludeText = JSON.stringify(\n\t\t\tArray.from(new Set([\"node_modules\", ...exclude])).sort(),\n\t\t);\n\n\t\treturn {\n\t\t\taddons: [\n\t\t\t\tblockCSpell({\n\t\t\t\t\tignorePaths: [\"coverage\"],\n\t\t\t\t}),\n\t\t\t\tblockDevelopmentDocs({\n\t\t\t\t\tsections: {\n\t\t\t\t\t\tTesting: {\n\t\t\t\t\t\t\tcontents: `\n[Vitest](https://vitest.dev) is used for tests.\nYou can run it locally on the command-line:\n\n\\`\\`\\`shell\npnpm run test\n\\`\\`\\`\n\nAdd the \\`--coverage\\` flag to compute test coverage and place reports in the \\`coverage/\\` directory:\n\n\\`\\`\\`shell\npnpm run test --coverage\n\\`\\`\\`\n\nNote that [console-fail-test](https://github.com/JoshuaKGoldberg/console-fail-test) is enabled for all test runs.\nCalls to \\`console.log\\`, \\`console.warn\\`, and other console methods will cause a test to fail.\n\n\n\t\t`,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tblockESLint({\n\t\t\t\t\textensions: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\textends: [\"vitest.configs.recommended\"],\n\t\t\t\t\t\t\tfiles: [\"**/*.test.*\"],\n\t\t\t\t\t\t\trules: [\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tentries: {\n\t\t\t\t\t\t\t\t\t\t\"@typescript-eslint/no-unsafe-assignment\": \"off\",\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t],\n\t\t\t\t\t\t\tsettings: {\n\t\t\t\t\t\t\t\tvitest: { typecheck: true },\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\tignores: [\"coverage\", \"**/*.snap\"],\n\t\t\t\t\timports: [{ source: \"@vitest/eslint-plugin\", specifier: \"vitest\" }],\n\t\t\t\t}),\n\t\t\t\tblockExampleFiles({\n\t\t\t\t\tfiles: {\n\t\t\t\t\t\t\"greet.test.ts\": `import { describe, expect, it, vi } from \"vitest\";\n\nimport { greet } from \"./greet.js\";\n\nconst message = \"Yay, testing!\";\n\ndescribe(greet, () => {\n\tit(\"logs to the console once when message is provided as a string\", () => {\n\t\tconst logger = vi.spyOn(console, \"log\").mockImplementation(() => undefined);\n\n\t\tgreet(message);\n\n\t\texpect(logger).toHaveBeenCalledWith(message);\n\t\texpect(logger).toHaveBeenCalledTimes(1);\n\t});\n\n\tit(\"logs to the console once when message is provided as an object\", () => {\n\t\tconst logger = vi.spyOn(console, \"log\").mockImplementation(() => undefined);\n\n\t\tgreet({ message });\n\n\t\texpect(logger).toHaveBeenCalledWith(message);\n\t\texpect(logger).toHaveBeenCalledTimes(1);\n\t});\n\n\tit(\"logs once when times is not provided in an object\", () => {\n\t\tconst logger = vi.fn();\n\n\t\tgreet({ logger, message });\n\n\t\texpect(logger).toHaveBeenCalledWith(message);\n\t\texpect(logger).toHaveBeenCalledTimes(1);\n\t});\n\n\tit(\"logs a specified number of times when times is provided\", () => {\n\t\tconst logger = vi.fn();\n\t\tconst times = 7;\n\n\t\tgreet({ logger, message, times });\n\n\t\texpect(logger).toHaveBeenCalledWith(message);\n\t\texpect(logger).toHaveBeenCalledTimes(7);\n\t});\n});\n`,\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tblockGitignore({\n\t\t\t\t\tignores: [\"/coverage\"],\n\t\t\t\t}),\n\t\t\t\tblockGitHubActionsCI({\n\t\t\t\t\tjobs: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname: \"Test\",\n\t\t\t\t\t\t\tsteps: [{ run: \"pnpm run test --coverage\" }, ...actionSteps],\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t\tblockKnip({\n\t\t\t\t\tentry: [\"src/**/*.test.*\"],\n\t\t\t\t}),\n\t\t\t\tblockPackageJson({\n\t\t\t\t\tproperties: {\n\t\t\t\t\t\tdevDependencies: getPackageDependencies(\n\t\t\t\t\t\t\t\"@vitest/coverage-v8\",\n\t\t\t\t\t\t\t\"@vitest/eslint-plugin\",\n\t\t\t\t\t\t\t\"console-fail-test\",\n\t\t\t\t\t\t\t\"vitest\",\n\t\t\t\t\t\t),\n\t\t\t\t\t\tscripts: {\n\t\t\t\t\t\t\ttest: `vitest ${addons.flags.join(\" \")}`.trim(),\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t}),\n\t\t\t\tblockPrettier({\n\t\t\t\t\tignores: [\"/coverage\"],\n\t\t\t\t}),\n\t\t\t\tblockTSDown({\n\t\t\t\t\tentry: [\"!src/**/*.test.*\"],\n\t\t\t\t}),\n\t\t\t\tblockVSCode({\n\t\t\t\t\tdebuggers: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\targs: [\"run\", \"${relativeFile}\"],\n\t\t\t\t\t\t\tautoAttachChildProcesses: true,\n\t\t\t\t\t\t\tconsole: \"integratedTerminal\",\n\t\t\t\t\t\t\tname: \"Debug Current Test File\",\n\t\t\t\t\t\t\tprogram: \"${workspaceRoot}/node_modules/vitest/vitest.mjs\",\n\t\t\t\t\t\t\trequest: \"launch\",\n\t\t\t\t\t\t\tskipFiles: [\"<node_internals>/**\", \"**/node_modules/**\"],\n\t\t\t\t\t\t\tsmartStep: true,\n\t\t\t\t\t\t\ttype: \"node\",\n\t\t\t\t\t\t},\n\t\t\t\t\t],\n\t\t\t\t\textensions: [\"vitest.explorer\"],\n\t\t\t\t}),\n\t\t\t],\n\t\t\tfiles: {\n\t\t\t\t\"vitest.config.ts\": `import { defineConfig } from \"vitest/config\";\n\nexport default defineConfig({\n\ttest: {\n\t\tclearMocks: true,\n\t\tcoverage: {\n\t\t\t${\n\t\t\t\tcoverage.exclude?.length\n\t\t\t\t\t? `exclude: ${JSON.stringify(coverage.exclude)},\n\t\t\t`\n\t\t\t\t\t: \"\"\n\t\t\t}include: ${JSON.stringify(coverage.include)},\n\t\t\treporter: [\"html\", \"lcov\"],\n\t\t},${\n\t\t\tenvironment\n\t\t\t\t? `\n\t\tenvironment: \"${environment}\",`\n\t\t\t\t: \"\"\n\t\t}\n\t\texclude: [${excludeText.slice(1, excludeText.length - 1)}],\n\t\tsetupFiles: [\"console-fail-test/setup\"],\n\t},\n});\n\t`,\n\t\t\t},\n\t\t};\n\t},\n\ttransition() {\n\t\treturn {\n\t\t\taddons: [\n\t\t\t\tblockRemoveDependencies({\n\t\t\t\t\tdependencies: [\n\t\t\t\t\t\t\"@vitest/coverage-istanbul\",\n\t\t\t\t\t\t\"eslint-plugin-jest\",\n\t\t\t\t\t\t\"eslint-plugin-mocha\",\n\t\t\t\t\t\t\"eslint-plugin-vitest\",\n\t\t\t\t\t\t\"jest mocha\",\n\t\t\t\t\t],\n\t\t\t\t}),\n\t\t\t\tblockRemoveFiles({\n\t\t\t\t\tfiles: [\".mocha*\", \"jest.config.*\", \"vitest.config.{c,j,m}*\"],\n\t\t\t\t}),\n\t\t\t\tblockRemoveWorkflows({\n\t\t\t\t\tworkflows: [\"test\"],\n\t\t\t\t}),\n\t\t\t],\n\t\t};\n\t},\n});\n"],"mappings":"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"}