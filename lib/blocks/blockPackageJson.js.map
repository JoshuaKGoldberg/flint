{"version":3,"file":"blockPackageJson.js","names":[],"sources":["../../src/blocks/blockPackageJson.ts"],"sourcesContent":["import removeUndefinedObjects from \"remove-undefined-objects\";\nimport semver from \"semver\";\nimport sortPackageJson from \"sort-package-json\";\nimport { z } from \"zod\";\nimport { PackageJson } from \"zod-package-json\";\n\nimport { base } from \"../base.js\";\nimport { htmlToTextSafe } from \"../utils/htmlToTextSafe.js\";\nimport { blockRemoveFiles } from \"./blockRemoveFiles.js\";\nimport { CommandPhase } from \"./phases.js\";\n\nconst PackageJsonWithNullableScripts = PackageJson.partial().extend({\n\tscripts: z\n\t\t.record(z.string(), z.union([z.string(), z.undefined()]))\n\t\t.optional(),\n});\n\nexport const blockPackageJson = base.createBlock({\n\tabout: {\n\t\tname: \"Package JSON\",\n\t},\n\taddons: {\n\t\tcleanupCommands: z.array(z.string()).default([]),\n\t\tproperties: PackageJsonWithNullableScripts.default({}),\n\t},\n\tproduce({ addons, offline, options }) {\n\t\tconst dependencies = useLargerVersions(options.packageData?.dependencies, {\n\t\t\t...options.packageData?.dependencies,\n\t\t\t...addons.properties.dependencies,\n\t\t});\n\t\tconst devDependencies = useLargerVersions(\n\t\t\toptions.packageData?.devDependencies,\n\t\t\t{\n\t\t\t\t...options.packageData?.devDependencies,\n\t\t\t\t...addons.properties.devDependencies,\n\t\t\t},\n\t\t);\n\t\tconst description = htmlToTextSafe(options.description);\n\n\t\treturn {\n\t\t\tfiles: {\n\t\t\t\t\"package.json\": sortPackageJson(\n\t\t\t\t\tJSON.stringify(\n\t\t\t\t\t\tremoveUndefinedObjects({\n\t\t\t\t\t\t\t...options.packageData,\n\t\t\t\t\t\t\t...addons.properties,\n\t\t\t\t\t\t\tauthor: { email: options.email.npm, name: options.author },\n\t\t\t\t\t\t\tbin: options.bin,\n\t\t\t\t\t\t\tdependencies: Object.keys(dependencies).length\n\t\t\t\t\t\t\t\t? dependencies\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\tdescription,\n\t\t\t\t\t\t\tdevDependencies: Object.keys(devDependencies).length\n\t\t\t\t\t\t\t\t? devDependencies\n\t\t\t\t\t\t\t\t: undefined,\n\t\t\t\t\t\t\tengines: {\n\t\t\t\t\t\t\t\tnode: `>=${options.node.minimum}`,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t...(options.pnpm && {\n\t\t\t\t\t\t\t\tpackageManager: `pnpm@${options.pnpm}`,\n\t\t\t\t\t\t\t}),\n\t\t\t\t\t\t\tfiles: processFiles(addons.properties.files),\n\t\t\t\t\t\t\tkeywords: options.keywords,\n\t\t\t\t\t\t\tname: options.repository,\n\t\t\t\t\t\t\trepository: {\n\t\t\t\t\t\t\t\ttype: \"git\",\n\t\t\t\t\t\t\t\turl: `git+https://github.com/${options.owner}/${options.repository}.git`,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\tscripts: {\n\t\t\t\t\t\t\t\t...options.packageData?.scripts,\n\t\t\t\t\t\t\t\t...addons.properties.scripts,\n\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\ttype: options.type ?? \"module\",\n\t\t\t\t\t\t\tversion: options.version ?? \"0.0.0\",\n\t\t\t\t\t\t}),\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t},\n\t\t\tscripts: [\n\t\t\t\t{\n\t\t\t\t\tcommands: [\n\t\t\t\t\t\t`pnpm install ${offline ? \"--offline \" : \"\"}--no-frozen-lockfile`,\n\t\t\t\t\t\t...addons.cleanupCommands,\n\t\t\t\t\t],\n\t\t\t\t\tphase: CommandPhase.Install,\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t},\n\ttransition() {\n\t\treturn {\n\t\t\taddons: [blockRemoveFiles({ files: [\"package-lock.json yarn.lock\"] })],\n\t\t};\n\t},\n});\n\nfunction processFiles(files: string[] | undefined) {\n\t// If no files have been specified, we can skip the property altogether\n\tif (!files?.length) {\n\t\treturn undefined;\n\t}\n\n\t// First sort so that shorter entries are first (e.g. \"lib/\")...\n\tconst sortedByLength = files\n\t\t.filter(Boolean)\n\t\t.sort((a, b) => a.length - b.length);\n\n\t// ...then remove entries captured by earlier directories (e.g. \"lib/index.js\")\n\treturn sortedByLength\n\t\t.filter(\n\t\t\t(file, i) =>\n\t\t\t\t!sortedByLength\n\t\t\t\t\t.slice(0, i)\n\t\t\t\t\t.some((earlier) => earlier.endsWith(\"/\") && file.startsWith(earlier)),\n\t\t)\n\t\t.sort();\n}\n\nfunction removeRangePrefix(version: string) {\n\tconst raw = version.replaceAll(/[\\^~><=]/gu, \"\").split(\" \")[0];\n\n\treturn semver.coerce(raw) ?? raw;\n}\n\nfunction useLargerVersion(existing: string | undefined, replacement: string) {\n\tif (!existing || existing === replacement) {\n\t\treturn replacement;\n\t}\n\n\tconst existingCoerced = semver.coerce(removeRangePrefix(existing));\n\n\treturn existingCoerced &&\n\t\tsemver.gt(existingCoerced, removeRangePrefix(replacement))\n\t\t? existing\n\t\t: replacement;\n}\n\nfunction useLargerVersions(\n\texisting: Record<string, string | undefined> | undefined,\n\treplacements: Record<string, string>,\n) {\n\tif (!existing) {\n\t\treturn replacements;\n\t}\n\n\treturn Object.fromEntries(\n\t\tObject.entries(replacements).map(([key, replacement]) => [\n\t\t\tkey,\n\t\t\tuseLargerVersion(existing[key], replacement),\n\t\t]),\n\t);\n}\n"],"mappings":"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"}