{"version":3,"file":"blockRepositoryBranchRuleset.js","names":[],"sources":["../../src/blocks/blockRepositoryBranchRuleset.ts"],"sourcesContent":["import type { CreatedOctokitRequest } from \"bingo-requests\";\n\nimport { z } from \"zod\";\n\nimport { base, BaseOptions } from \"../base.js\";\n\nexport const blockRepositoryBranchRuleset = base.createBlock({\n\tabout: {\n\t\tname: \"Repository Branch Ruleset\",\n\t},\n\taddons: {\n\t\trequiredStatusChecks: z.array(z.string()).optional(),\n\t},\n\tsetup({ addons, options }) {\n\t\treturn {\n\t\t\trequests: [\n\t\t\t\t{\n\t\t\t\t\tendpoint: \"POST /repos/{owner}/{repo}/rulesets\",\n\t\t\t\t\tparameters: createRulesetParameters(\n\t\t\t\t\t\taddons.requiredStatusChecks,\n\t\t\t\t\t\toptions,\n\t\t\t\t\t),\n\t\t\t\t\ttype: \"octokit\",\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\t},\n\ttransition({ addons, options }) {\n\t\treturn {\n\t\t\trequests: [\n\t\t\t\t{\n\t\t\t\t\tendpoint: \"DELETE /repos/{owner}/{repo}/branches/{branch}/protection\",\n\t\t\t\t\tparameters: {\n\t\t\t\t\t\tbranch: \"main\",\n\t\t\t\t\t\towner: options.owner,\n\t\t\t\t\t\trepo: options.repository,\n\t\t\t\t\t},\n\t\t\t\t\tsilent: true,\n\t\t\t\t\ttype: \"octokit\",\n\t\t\t\t},\n\t\t\t\toptions.rulesetId\n\t\t\t\t\t? {\n\t\t\t\t\t\t\tendpoint: \"PUT /repos/{owner}/{repo}/rulesets/{ruleset_id}\",\n\t\t\t\t\t\t\tparameters: createRulesetParameters(\n\t\t\t\t\t\t\t\taddons.requiredStatusChecks,\n\t\t\t\t\t\t\t\toptions,\n\t\t\t\t\t\t\t\toptions.rulesetId,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\ttype: \"octokit\",\n\t\t\t\t\t\t}\n\t\t\t\t\t: {\n\t\t\t\t\t\t\tendpoint: \"POST /repos/{owner}/{repo}/rulesets\",\n\t\t\t\t\t\t\tparameters: createRulesetParameters(\n\t\t\t\t\t\t\t\taddons.requiredStatusChecks,\n\t\t\t\t\t\t\t\toptions,\n\t\t\t\t\t\t\t),\n\t\t\t\t\t\t\ttype: \"octokit\",\n\t\t\t\t\t\t},\n\t\t\t],\n\t\t};\n\t},\n\t// TODO: Make produce() optional, so this empty-ish produce() can be removed\n\t// https://github.com/JoshuaKGoldberg/bingo/issues/295\n\tproduce() {\n\t\treturn {};\n\t},\n});\n\nfunction createRulesetParameters(\n\tcontexts: string[] | undefined,\n\toptions: BaseOptions,\n\trulesetId?: string,\n) {\n\treturn {\n\t\tbypass_actors: [\n\t\t\t{\n\t\t\t\t// This *seems* to be the Repository Admin role always?\n\t\t\t\t// https://github.com/github/rest-api-description/issues/4406\n\t\t\t\tactor_id: 5,\n\t\t\t\tactor_type: \"RepositoryRole\",\n\t\t\t\tbypass_mode: \"always\",\n\t\t\t},\n\t\t],\n\t\tconditions: {\n\t\t\tref_name: {\n\t\t\t\texclude: [],\n\t\t\t\tinclude: [\"refs/heads/main\"],\n\t\t\t},\n\t\t},\n\t\tenforcement: \"active\",\n\t\tname: \"Branch protection for main\",\n\t\towner: options.owner,\n\t\trepo: options.repository,\n\t\trules: [\n\t\t\t{ type: \"deletion\" },\n\t\t\t{\n\t\t\t\tparameters: {\n\t\t\t\t\tallowed_merge_methods: [\"squash\"],\n\t\t\t\t\tdismiss_stale_reviews_on_push: false,\n\t\t\t\t\trequire_code_owner_review: false,\n\t\t\t\t\trequire_last_push_approval: false,\n\t\t\t\t\trequired_approving_review_count: 0,\n\t\t\t\t\trequired_review_thread_resolution: false,\n\t\t\t\t},\n\t\t\t\ttype: \"pull_request\",\n\t\t\t},\n\t\t\t{\n\t\t\t\tparameters: {\n\t\t\t\t\trequired_status_checks:\n\t\t\t\t\t\tcontexts?.map((context) => ({\n\t\t\t\t\t\t\tcontext,\n\t\t\t\t\t\t})) ?? [],\n\t\t\t\t\tstrict_required_status_checks_policy: false,\n\t\t\t\t},\n\t\t\t\ttype: \"required_status_checks\",\n\t\t\t},\n\t\t],\n\t\truleset_id: rulesetId === undefined ? rulesetId : Number(rulesetId),\n\t\ttarget: \"branch\",\n\t} satisfies CreatedOctokitRequest[\"parameters\"];\n}\n"],"mappings":";;;;AAMA,MAAa,+BAA+B,KAAK,YAAY;CAC5D,OAAO,EACN,MAAM,6BACN;CACD,QAAQ,EACP,sBAAsB,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC,UAAU,EACpD;CACD,MAAM,EAAE,QAAQ,WAAW;AAC1B,SAAO,EACN,UAAU,CACT;GACC,UAAU;GACV,YAAY,wBACX,OAAO,sBACP,QACA;GACD,MAAM;GACN,CACD,EACD;;CAEF,WAAW,EAAE,QAAQ,WAAW;AAC/B,SAAO,EACN,UAAU,CACT;GACC,UAAU;GACV,YAAY;IACX,QAAQ;IACR,OAAO,QAAQ;IACf,MAAM,QAAQ;IACd;GACD,QAAQ;GACR,MAAM;GACN,EACD,QAAQ,YACL;GACA,UAAU;GACV,YAAY,wBACX,OAAO,sBACP,SACA,QAAQ,UACR;GACD,MAAM;GACN,GACA;GACA,UAAU;GACV,YAAY,wBACX,OAAO,sBACP,QACA;GACD,MAAM;GACN,CACH,EACD;;CAIF,UAAU;AACT,SAAO,EAAE;;CAEV,CAAC;AAEF,SAAS,wBACR,UACA,SACA,WACC;AACD,QAAO;EACN,eAAe,CACd;GAGC,UAAU;GACV,YAAY;GACZ,aAAa;GACb,CACD;EACD,YAAY,EACX,UAAU;GACT,SAAS,EAAE;GACX,SAAS,CAAC,kBAAkB;GAC5B,EACD;EACD,aAAa;EACb,MAAM;EACN,OAAO,QAAQ;EACf,MAAM,QAAQ;EACd,OAAO;GACN,EAAE,MAAM,YAAY;GACpB;IACC,YAAY;KACX,uBAAuB,CAAC,SAAS;KACjC,+BAA+B;KAC/B,2BAA2B;KAC3B,4BAA4B;KAC5B,iCAAiC;KACjC,mCAAmC;KACnC;IACD,MAAM;IACN;GACD;IACC,YAAY;KACX,wBACC,UAAU,KAAK,aAAa,EAC3B,SACA,EAAE,IAAI,EAAE;KACV,sCAAsC;KACtC;IACD,MAAM;IACN;GACD;EACD,YAAY,cAAc,SAAY,YAAY,OAAO,UAAU;EACnE,QAAQ;EACR"}